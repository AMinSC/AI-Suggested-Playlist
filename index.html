<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chat</title>
</head>
<body>
    <div>
        <ul></ul>
        <form action="post">
            <input type="text" autofocus />
            <button type="submit">전송</button>
        </form>
        <ol id="vedioList"></ol>
    </div>
    <!-- <script type="text/javascript" src="apikey.js"> -->
    <script>
        // const YOUTUBE_API = "config.apikey";
        const $form = document.querySelector("form");
        const $input = document.querySelector("input");
        const $chatList = document.querySelector("ul");
        const $vedioList = document.querySelector("#vedioList");
        let videoIdCounter = 0;
        let gptRecList = ''


        // openAI API
        let openAIUrl = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;

        // 사용자의 질문
        let question;

        // 질문과 답변 저장
        let data = [
            {
                "role": "system", 
                "content": "assistant는 노래 전문가이다."
            }, 
        ];

        //YOUTUBE DATA API v3. Search
        //help for params : https://developers.google.com/youtube/v3/docs/search/list#--

        let optionParams={
            q: '',
            part: "snippet",
            key: YOUTUBE_API,
            type: "video",
            maxResults: 1,
            order: "viewCount",
            regionCode: "KR",
            videoDuration: "medium",
            videoEmbeddable: "true",  // ture일 경우 퍼갈 수 있는 영상만 검색
        };


        //한글을 검색어로 전달하기 위해선 url encoding 필요!
        optionParams.q = encodeURI(optionParams.q);

        // 화면에 뿌려줄 데이터, 질문들
        let questionData = [];

        // input에 입력된 질문 받아오는 함수
        $input.addEventListener("input", (e) => {
            question = e.target.value;
        });


        // youtube api 를 활용하여, ChatGPT가 추천해준 노래 리스트를 search 한 뒤, 영상 제목과 영상 id 가져오는 함수
        const getVideoId = (recList) => {
            for (const i of recList) {
                optionParams['q'] = i
                let url="https://www.googleapis.com/youtube/v3/search?";
                for(let option in optionParams){
                    url += option + "=" + optionParams[option] + "&";
                }

                //url의마지막에 붙어있는 & 정리
                url = url.substr(0, url.length - 1);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`2 : ${data.items[0].id.videoId}`)
                        printVedio(data.items[0].id.videoId)
                    })
                    .catch(error => console.log(error));
            }
        }


        // 사용자의 질문을 객체를 만들어서 push
        const sendQuestion = (question) => {
        if (question) {
            data.push({
            role: "user",
            content: question,
            });
            questionData.push({
            role: "user",
            content: question,
            });
        }
        };

        // 화면에 질문 그려주는 함수
        const printQuestion = async () => {
        if (question) {
            let li = document.createElement("li");
            li.classList.add("question");
            questionData.map((el) => {
            li.innerText = el.content;
            });
            $chatList.appendChild(li);
            questionData = [];
            question = false;
        }
        };

        // 화면에 답변 그려주는 함수
        const printAnswer = (answer) => {
        let li = document.createElement("li");
        li.classList.add("answer");
        li.innerText = answer;
        $chatList.appendChild(li);
        };

        // 화면에 답변 그려주는 함수
        function printVedio (t) {
            let li = document.createElement("li");
            li.id = "player" + videoIdCounter++;
            $vedioList.appendChild(li);

            onYouTubeIframeAPIReady(li.id, t); // pass the id to the function
        };

        // youtube vedio 가져오는 함수
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady(liId, t) {
            new YT.Player(liId, {
            height: '240',
            width: '360',
            videoId: t, // Use t (the inputted text) as the video id
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        var done = false;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                setTimeout(stopVideo, 6000);
                done = true;
            }
        }
        function stopVideo() {
        }

        // api 요청보내는 함수
        const apiPost = async () => {
        const result = await fetch(openAIUrl, {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
            redirect: "follow",
        })
            .then((res) => res.json())
            .then((res) => {
            gptRecList = res.choices[0].message.content.split('\n').slice(2, 12)
            getVideoId(gptRecList)  // youtube API 활용하여 title과 videoId 가져오는 함수
            console.log(`1 : ${gptRecList}`)  // 노래 리스트 확인
            printAnswer(res.choices[0].message.content);
            // printVedio 들어갈 공간
            // let vedioIdList;
            // vedioIdList.push(recDict)
            // for (const item of recDict) {
            //     printVedio(item)
            // }
            console.log(`3 : ${recDict}`)
            })
            .catch((err) => {
            console.log(err);
            });
        };
        

        // submit
        $form.addEventListener("submit", (e) => {
        e.preventDefault();
        $input.value = null;
        sendQuestion(question);
        apiPost();
        printQuestion();
        });
    </script>
</body>
</html>